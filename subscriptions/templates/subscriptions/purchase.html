{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ STRIPE_PUBLIC_KEY }}');
</script>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <!-- Security Banner -->
    <div class="mb-8 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    <span class="ml-2 text-sm text-gray-600">Secure Payment</span>
                </div>
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    <span class="ml-2 text-sm text-gray-600">256-bit Encryption</span>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <img src="{% static 'images/credits/visa-master-paypal.png' %}" alt="Payment Methods" class="h-8">
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- Plan Details and Duration Selection -->
        <div class="md:col-span-2 space-y-6">
            <!-- Plan Header -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h2 class="text-2xl font-bold text-gray-900">{{ plan.name }}</h2>
                <p class="mt-2 text-gray-600">{{ plan.description }}</p>
            </div>

            <!-- Features -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Included Features</h3>
                
                {% if tools %}
                <div class="mb-6">
                    <h4 class="text-md font-medium text-gray-700 mb-2">Tools</h4>
                    <ul class="space-y-2">
                        {% for tool in tools %}
                        <li class="flex items-center text-gray-600">
                            <svg class="h-5 w-5 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            {{ tool.name }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if services %}
                <div>
                    <h4 class="text-md font-medium text-gray-700 mb-2">Services</h4>
                    <ul class="space-y-2">
                        {% for service in services %}
                        <li class="flex items-center text-gray-600">
                            <svg class="h-5 w-5 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            {{ service.name }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>

            <!-- Duration Selection -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Select Duration</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {% for duration in durations %}
                    <div class="duration-select border rounded-lg p-4 cursor-pointer hover:border-[#1980e6] transition-colors"
                         data-duration-id="{{ duration.id }}"
                         data-price="{{ duration.price }}">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900">
                                    {{ duration.get_duration_type_display }}
                                </h4>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-[#1980e6]">${{ duration.price }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Payment Form -->
        <div class="md:col-span-1">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 sticky top-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Details</h2>
                <form id="payment-form" class="space-y-4">
                    {% csrf_token %}
                    <input type="hidden" id="selected-duration" name="duration_id" value="">

                    <!-- Card holder name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Card Holder Name
                        </label>
                        <input type="text" id="cardholder-name" required
                               class="block w-full border-gray-300 rounded-md shadow-sm"
                               placeholder="Name on card">
                    </div>

                    <!-- Card Elements -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Card Information
                        </label>
                        <div id="card-element" class="p-3 border rounded-md bg-gray-50">
                            <!-- Stripe Elements will be inserted here -->
                        </div>
                    </div>

                    <div id="card-errors" class="mt-1 text-sm text-red-600" role="alert"></div>

                    <!-- Save Card Option -->
                    <div class="flex items-center">
                        <input type="checkbox" id="save-card" name="save-card"
                               class="h-4 w-4 text-[#1980e6] border-gray-300 rounded">
                        <label for="save-card" class="ml-2 block text-sm text-gray-700">
                            Save card for future payments
                        </label>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" 
                            id="submit-button"
                            disabled
                            class="w-full bg-[#1980e6] text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                        <span id="spinner" class="hidden mr-2">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                        Pay <span id="payment-amount">$0.00</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Stripe Elements
    const elements = stripe.elements();
    const card = elements.create('card');
    card.mount('#card-element');

    // Duration selection handling
    const durations = document.querySelectorAll('.duration-select');
    const submitButton = document.getElementById('submit-button');
    const paymentAmount = document.getElementById('payment-amount');
    const selectedDurationInput = document.getElementById('selected-duration');
    let selectedDurationId = null;

    durations.forEach(duration => {
        duration.addEventListener('click', function() {
            // Remove selection from all durations
            durations.forEach(d => d.classList.remove('border-[#1980e6]', 'border-2'));
            
            // Add selection to clicked duration
            this.classList.add('border-[#1980e6]', 'border-2');
            
            // Update selected duration and price
            selectedDurationId = this.dataset.durationId;
            const price = this.dataset.price;
            
            selectedDurationInput.value = selectedDurationId;
            paymentAmount.textContent = `$${price}`;
            submitButton.disabled = false;
        });
    });

    // Handle form submission
    const form = document.getElementById('payment-form');
    const spinner = document.getElementById('spinner');

    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        if (!selectedDurationId) {
            alert('Please select a duration');
            return;
        }

        submitButton.disabled = true;
        spinner.classList.remove('hidden');

        const cardholderName = document.getElementById('cardholder-name').value;

        try {
            const {paymentMethod, error} = await stripe.createPaymentMethod({
                type: 'card',
                card: card,
                billing_details: {
                    name: cardholderName,
                }
            });

            if (error) {
                handleError(error);
                return;
            }

            // Process payment
            const response = await fetch(`/subscriptions/process-payment/{{ plan.id }}/${selectedDurationId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({
                    payment_method_id: paymentMethod.id,
                    save_card: document.getElementById('save-card').checked,
                    return_url: '{{ return_url|safe }}'
                })
            });

            const result = await response.json();

            if (result.success) {
                window.location.href = result.redirect_url;
            } else {
                handleError(new Error(result.error));
            }

        } catch (error) {
            handleError(error);
        }
    });

    function handleError(error) {
        const errorElement = document.getElementById('card-errors');
        errorElement.textContent = error.message;
        submitButton.disabled = false;
        spinner.classList.add('hidden');
    }
});
</script>
{% endblock %} 